{% extends "base.njk" %}

{% block structured_data %}
        <script type="application/ld+json">
            {
            "@context": "https://schema.org",
            "@type": "BlogPosting",
            "headline": "{{ title }}",
            "description": "{{ subtitle or site.subtitle }}",
            "author": {
                "@type": "Person",
                "name": "{{ site.authorName }}",
                "url": "{{ site.url }}"
            },
            "datePublished": "{{ page.date.toISOString() }}",
            "dateModified": "{{ page.inputPath | lastModifiedDate }}",
            "url": "{{ site.url }}{{ page.url }}",
            "mainEntityOfPage": {
                "@type": "WebPage",
                "@id": "{{ site.url }}{{ page.url }}"
            },
            "image": "{{ site.url }}{{ featured_image }}",
            "keywords": "{{ tags | join(', ') }}",
            "wordCount": "{{ content | wordCount }}",
            "articleBody": "{{ content | replace('<p>', '') | replace('</p>', ' ') | striptags | truncate(500) | escape }}"
            }
        </script>
{% endblock %}

{% block article_header %}
            <div class="progress-bar"></div>
            <h1>{{ title | markdownInline | safe }}</h1>
            {% if subtitle %}<p class="subtitle">{{ subtitle | markdownInline | safe }}</p>{% endif %}
            {% if date %}<p class="date">{{ date | postDate }}</p>{% endif %}
            <nav class="toc"></nav>
            <script>
                (function() {
                    var bar = document.querySelector('.progress-bar');
                    window.addEventListener('scroll', function() {
                        var scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
                        var scrollHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
                        var progress = scrollHeight > 0 ? (scrollTop / scrollHeight) * 100 : 0;
                        bar.style.width = progress + '%';
                    });

                    var headings = document.querySelectorAll('article h2, article h3');
                    if (headings.length >= 3) {
                        var toc = document.querySelector('.toc');
                        var ol = document.createElement('ol');
                        var currentH2Item = null;
                        var nestedOl = null;
                        headings.forEach(function(h) {
                            var li = document.createElement('li');
                            var a = document.createElement('a');
                            a.href = '#' + h.id;
                            a.textContent = h.textContent;
                            li.appendChild(a);
                            if (h.tagName === 'H2') {
                                currentH2Item = li;
                                nestedOl = null;
                                ol.appendChild(li);
                            } else {
                                if (!nestedOl) {
                                    nestedOl = document.createElement('ol');
                                    if (currentH2Item) {
                                        currentH2Item.appendChild(nestedOl);
                                    } else {
                                        ol.appendChild(li);
                                        return;
                                    }
                                }
                                nestedOl.appendChild(li);
                            }
                        });
                        toc.appendChild(ol);
                    }
                })();
            </script>
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    if (typeof RoughNotation === 'undefined') return;
                    var reduceMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
                    var headings = document.querySelectorAll('article h2');
                    var observer = new IntersectionObserver(function(entries) {
                        entries.forEach(function(entry) {
                            if (entry.isIntersecting) {
                                var annotation = RoughNotation.annotate(entry.target, {
                                    type: 'bracket',
                                    brackets: ['left'],
                                    color: 'rgba(86, 130, 89, 0.5)',
                                    strokeWidth: 2,
                                    padding: [2, 0, 2, 8],
                                    animationDuration: 600,
                                    animate: !reduceMotion
                                });
                                annotation.show();
                                observer.unobserve(entry.target);
                            }
                        });
                    }, { threshold: 0.5 });
                    headings.forEach(function(h) { observer.observe(h); });
                });
            </script>
{% endblock %}
